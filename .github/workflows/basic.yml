name: build 

on:
  push:
    paths-ignore:
      - '**/*.md'
  pull_request:
    paths-ignore:
      - '**/*.md'

env:
  CMAKE_BUILD_TYPE: Coverage
  CMAKE_BUILD_DIR: ${{github.workspace}}/build
  HADOOP_VER: 3.2.2
  AWSSDK_VER: 1.8.114
  AWSSDK_ROOT_DIR: ${{github.workspace}}/awssdk

jobs:
  build:
    strategy:
      matrix:
        os: [ubuntu-18.04, ubuntu-latest, macOS-latest]
        # os: [ubuntu-20.04, macOS-10.15]
        # All supported types
        type: [basic, basic-no-hdfs, basic-codec, hdfs, gcs, azure, azurite, aws, minio]
        exclude:
          - os: macos-latest
            type: basic-no-hdfs
          - os: macos-latest
            type: basic-codec
          - os: macos-latest
            type: hdfs
          - os: macos-latest
            type: gcs
          - os: macos-latest
            type: azure
          - os: macos-latest
            type: azurite
          - os: macos-latest
            type: aws
          - os: macos-latest
            type: minio

    runs-on: ${{ matrix.os }}

    steps:
    - uses: actions/checkout@v2

    - name: Create Build Environment
      shell: bash
      run: |
        mkdir -p $CMAKE_BUILD_DIR

    - name: Install Prereqs and Configure CMake - Ubuntu
      if: startsWith(matrix.os,'ubuntu')
      shell: bash
      working-directory: ${{env.CMAKE_BUILD_DIR}}
      run: |
        sudo apt-get update
        sudo apt-get -y install cmake lcov
        sudo apt-get -y install zlib1g-dev libssl-dev uuid-dev libcurl4-openssl-dev
        export ENABLE_ZSTD=0
        export ENABLE_BLOSC=0
        if [[ ${{matrix.type}} == "basic-no-hdfs" ]]; then
          export USE_HDFS="-DUSE_HDFS=0"
        fi
        if [[ ${{matrix.type}} == "basic-codec" ]]; then
          source $GITHUB_WORKSPACE/.github/scripts/install_supported_codec.sh
        fi
        echo "CMAKE VERSION=$(cmake --version)"
        cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE \
               -DENABLE_ZSTD=$ENABLE_ZSTD -DENABLE_BLOSC=$ENABLE_BLOSC -DAWSSDK_URL=$AWSSDK_URL $USE_HDFS
      env:
        AWSSDK_URL: https://github.com/aws/aws-sdk-cpp/archive/${{env.AWSSDK_VER}}.zip

    - name: Install Prereqs and Configure CMake - MacOS
      if: startsWith(matrix.os, 'macOS')
      shell: bash
      working-directory: ${{env.CMAKE_BUILD_DIR}}
      run: |
        brew list cmake &>/dev/null || brew install cmake
        brew list lcov &>/dev/null || brew install lcov
        brew list openssl@1.1 &>/dev/null || brew install openssl@1.1
        brew list ossp-uuid &>/dev/null || brew install ossp-uuid
        cmake $GITHUB_WORKSPACE -DCMAKE_BUILD_TYPE=$CMAKE_BUILD_TYPE -DAWSSDK_URL=$AWSSDK_URL
        # GCS SDK needs OPENSSL_ROOT_DIR set for MAC, so build here
        make -j4
      env:
        OPENSSL_ROOT_DIR: /usr/local/opt/openssl@1.1
        AWSSDK_URL: https://github.com/aws/aws-sdk-cpp/archive/${{env.AWSSDK_VER}}.zip

    - name: Build and Test
      if: startsWith(matrix.type, 'basic')
      shell: bash
      working-directory:  ${{env.CMAKE_BUILD_DIR}}
      run: |
        make -j4
        make tests -j 4
        export TILEDB_BENCHMARK=1
        time test/test_sparse_array_benchmark
        export TILEDB_DISABLE_FILE_LOCKING=1
        time test/test_sparse_array_benchmark
        export TILEDB_KEEP_FILE_HANDLES_OPEN=1
        time test/test_sparse_array_benchmark
        test/test_print_array_schema $GITHUB_WORKSPACE/test/inputs/examples_ws/sparse_arrays/my_array_B
        test/test_print_book_keeping $GITHUB_WORKSPACE/test/inputs/examples_ws/sparse_arrays/my_array_B/__4FECD19A-4F7D-4D21-B170-A2D111C8FCC44550772224_1652300381620

    - name: Cache AWS SDK
      uses: actions/cache@v2
      with:
        path: ${{env.AWSSDK_ROOT_DIR}}
        key: aws-${{env.AWSSDK_VER}}-v3

    - name: Cache Distributed FileSystems
      if: matrix.type == 'hdfs' || matrix.type == 'gcs'
      uses: actions/cache@v2
      with:
        path: ~/hadoop-${{env.HADOOP_VER}}
        key: dfs-${{env.HADOOP_VER}}-v1
        
    - name: Build and Test - Distributed FileSystems
      if: startsWith(matrix.type, 'basic') != true
      shell: bash
      working-directory:  ${{env.CMAKE_BUILD_DIR}}
      run: |
        if [[ ${{matrix.type}} == "azurite" ]]; then
          source $GITHUB_WORKSPACE/.github/scripts/install_azurite.sh
        elif [[ ${{matrix.type}} == "minio" ]]; then
          source $GITHUB_WORKSPACE/.github/scripts/install_minio.sh
        elif [[ ${{matrix.type}} == "aws" ]]; then
          source $GITHUB_WORKSPACE/.github/scripts/install_aws.sh
        else
          source $GITHUB_WORKSPACE/.github/scripts/install_hadoop.sh
        fi
        source $GITHUB_WORKSPACE/.github/scripts/run_dfs_tests.sh
      env:
        INSTALL_DIR: ${{runner.workspace}}
        INSTALL_TYPE: ${{matrix.type}}
        R_TAR: ${{secrets.R_TAR}}
        AZURITE_TAR: ${{secrets.AZURITE_TAR}}
        AWS_TAR: ${{secrets.AWS_TAR}}

    - name: Upload Report to CodeCov
      uses: codecov/codecov-action@v1
